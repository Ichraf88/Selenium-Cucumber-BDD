pipeline {
  agent any

   tools {
    jdk   'JAVA_HOME'     // ex: 'JDK21' dans mon cas JDK21.0.10
    maven 'MAVEN_HOME'    // ex: 'Maven3'
  }


  environment {
    BROWSER  = 'chrome'
    HEADLESS = 'true'
    TAGS     = ''   // ex: '@login' si tu veux filtrer
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build') {
      steps {
        bat 'java -version'
        bat 'mvn -version'
        bat 'mvn -B -ntp clean package -DskipTests'
      }
    }

    stages {

    stage('Init') {
      steps {
        bat 'java -version'
        bat 'mvn -version'
        echo "BROWSER=${params.BROWSER} | HEADLESS=${params.HEADLESS} | TAGS='${params.CUCUMBER_TAGS}' | RUN_E2E=${params.RUN_E2E}"
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build (compile/package)') {
      steps {
        // build sans tests = rapide + détecte erreurs de compilation tôt
        bat "%MVN% -DskipTests clean package"
      }
    }

    stage('Unit Tests (si tu en as)') {
      steps {
        // Si tu as des tests unitaires séparés : garde ce stage.
        // Sinon tu peux le supprimer.
        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
          bat "%MVN% test"
        }
      }
    }

    stage('E2E Tests (Cucumber/Selenium)') {
      when { expression { return params.RUN_E2E } }
      steps {
        // catchError pour continuer et publier les rapports même si des scénarios échouent
        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
          bat """
            %MVN% test ^
              -Dbrowser=${params.BROWSER} ^
              -Dheadless=${params.HEADLESS} ^
              -Dcucumber.filter.tags="${params.CUCUMBER_TAGS}"
          """
        }
      }
    }

    stage('Publish Reports') {
      steps {
        // JUnit (Surefire + Failsafe si tu ajoutes IT plus tard)
        junit testResults: 'target/surefire-reports/*.xml, target/failsafe-reports/*.xml',
              allowEmptyResults: true

        // Cucumber HTML (sans casser le build si absent)
        script {
          def reportFile = 'target/report/cucumber-report.html'
          if (fileExists(reportFile)) {
            publishHTML(target: [
              reportDir: 'target/report',
              reportFiles: 'cucumber-report.html',
              reportName: 'Cucumber Report',
              keepAll: true,
              alwaysLinkToLastBuild: true,
              allowMissing: false
            ])
          } else {
            echo "Rapport Cucumber introuvable: ${reportFile}"
          }
        }
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: 'target/report/**, target/screenshots/**, screenshots/**, logs/**',
                         allowEmptyArchive: true
      }
    }

    stage('Cleanup') {
      steps {
        // Nettoyage workspace (safe)
        // deleteDir() supprime le workspace du job
        deleteDir()
      }
    }
  }

  post {
    always {
      echo "Build terminé: ${currentBuild.currentResult}"
    }
  }
}
