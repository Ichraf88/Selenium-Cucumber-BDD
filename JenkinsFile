pipeline {
  agent any

  tools {
    // Mets ici les NOMS EXACTS de tes outils dans: Manage Jenkins > Tools
    jdk   'JDK21'
    maven 'Maven3'
  }

  parameters {
    choice(name: 'BROWSER', choices: ['chrome', 'edge'], description: 'Navigateur')
    booleanParam(name: 'HEADLESS', defaultValue: true, description: 'Mode headless')
    string(name: 'CUCUMBER_TAGS', defaultValue: '', description: 'Ex: @login (vide = tout)')
    booleanParam(name: 'RUN_E2E', defaultValue: true, description: 'Lancer les tests E2E')
  }

  stages {
    stage('Init') {
      steps {
        bat 'java -version'
        bat 'mvn -version'
        echo "BROWSER=${params.BROWSER} | HEADLESS=${params.HEADLESS} | TAGS='${params.CUCUMBER_TAGS}' | RUN_E2E=${params.RUN_E2E}"
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build (compile/package)') {
      steps {
        bat 'mvn -B -ntp -DskipTests clean package'
      }
    }

    stage('Unit Tests') {
      steps {
        // Si tu n'as pas de tests unitaires, tu peux supprimer ce stage.
        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
          bat 'mvn -B -ntp test'
        }
      }
    }

    stage('E2E Tests (Cucumber/Selenium)') {
      when { expression { return params.RUN_E2E } }
      steps {
        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
          bat """
            mvn -B -ntp test ^
              -Dbrowser=${params.BROWSER} ^
              -Dheadless=${params.HEADLESS} ^
              -Dcucumber.filter.tags="${params.CUCUMBER_TAGS}"
          """
        }
      }
    }

    stage('Publish / Archive') {
      steps {
        junit testResults: '**/target/surefire-reports/*.xml, **/target/failsafe-reports/*.xml',
              allowEmptyResults: true

        archiveArtifacts artifacts: 'target/report/**, target/screenshots/**, screenshots/**, logs/**',
                         allowEmptyArchive: true
      }
    }
  }

  post {
    always {
      echo "Build termin√©: ${currentBuild.currentResult}"
    }
  }
}
